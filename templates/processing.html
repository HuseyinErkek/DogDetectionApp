{% extends 'base.html' %}

{% block title %}Video İşleniyor{% endblock %}

{% block content %}
<div class="container mt-5">
    <!-- Başlık ve Durum -->
    <div class="text-center mb-4">
        <h2 class="text-white">
            <i class="bi bi-gear-wide-connected"></i> Video İşleme Durumu
        </h2>
        <div id="statusBadge" class="badge bg-secondary fs-6">
            <span id="statusText">Başlatılıyor...</span>
            <span id="statusSpinner" class="ms-2 spinner-border spinner-border-sm"></span>
        </div>
    </div>

    <!-- İlerleme Çubukları -->
    <div class="row g-4">
        <!-- Ana İlerleme -->
        <div class="col-md-6">
            <div class="card bg-dark text-white h-100">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-speedometer2"></i> Genel İlerleme</h5>
                </div>
                <div class="card-body">
                    <div class="progress mb-3" style="height: 25px;">
                        <div id="progressBar" class="progress-bar progress-bar-striped"
                             role="progressbar" style="width: 0%"></div>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span id="progressPercent">%0</span>
                        <span id="timeRemaining" class="text-muted">
                            <i class="bi bi-clock"></i> Tahmini: --
                        </span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Segment İlerleme -->
        <div class="col-md-6">
            <div class="card bg-dark text-white h-100">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-film"></i> Aktif Segment</h5>
                </div>
                <div class="card-body">
                    <div class="progress mb-3" style="height: 25px;">
                        <div id="segmentProgressBar" class="progress-bar bg-info"
                             role="progressbar" style="width: 0%"></div>
                    </div>
                    <div id="segmentInfo">
                        <small class="text-muted" id="segmentName">Segment hazırlanıyor...</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- İşlem Tamamlandı Butonu -->
    <div id="successSection" class="text-center mt-4 animate__animated animate__fadeIn" style="display: none;">
        <div class="alert alert-success d-inline-block">
            <i class="bi bi-check-circle-fill"></i>
            <span id="completionMessage">Video işleme tamamlandı!</span>
        </div>
        <div class="mt-3">
            <a id="showResultBtn" href="#" class="btn btn-success btn-lg px-4 py-2">
                <i class="bi bi-play-circle me-2"></i> Sonucu Görüntüle
            </a>
        </div>
    </div>

    <!-- Hata Mesajı -->
    <div id="errorAlert" class="alert alert-danger mt-4" style="display: none;">
        <i class="bi bi-exclamation-triangle-fill me-2"></i>
        <span id="errorText"></span>
    </div>

    <!-- İşlem Geçmişi -->
    <div class="card bg-dark text-white mt-4">
        <div class="card-header">
            <h5 class="mb-0"><i class="bi bi-list-ul"></i> İşlem Logları</h5>
        </div>
        <div class="card-body p-0">
            <div id="processLogs" class="list-group list-group-flush" style="max-height: 200px; overflow-y: auto;">
                <div class="list-group-item bg-secondary text-white">
                    <i class="bi bi-hourglass-top me-2"></i> Sistem başlatıldı...
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Gerekli Kütüphaneler -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.6.1/socket.io.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.js"></script>

<script>
    // Sistem Değişkenleri
    const config = {
        pollingInterval: 3000, // 3 saniyede bir kontrol
        sessionId: null,
        lastProgress: 0,
        startTime: null,
        pollingActive: true
    };

    // Socket Bağlantısı
    const socket = io('http://' + window.location.hostname + ':5000');

    // Debug Modu
    const debugMode = true;
    function logDebug(...messages) {
        if (debugMode) console.log('[DEBUG]', ...messages);
    }

    // Sayfa Yüklendiğinde
    document.addEventListener('DOMContentLoaded', () => {
        startPolling();
        initializeSocket();
    });

    // Polling Mekanizması
    function startPolling() {
        const poll = () => {
            if (!config.pollingActive) return;

            fetch(`/check_status?session=${config.sessionId}`)
                .then(response => response.json())
                .then(data => {
                    logDebug('Polling response:', data);

                    if (data.completed) {
                        handleCompletion(data.filename);
                    } else if (data.error) {
                        showError(data.error);
                    }
                })
                .catch(error => {
                    logDebug('Polling error:', error);
                })
                .finally(() => {
                    if (config.pollingActive) {
                        setTimeout(poll, config.pollingInterval);
                    }
                });
        };

        poll();
    }

    // Socket İşlemleri
    function initializeSocket() {
        // Session ID Alındığında
        socket.on('session_id', (data) => {
            config.sessionId = data.sessionId;
            config.startTime = new Date();
            addLog(`Session başlatıldı (ID: ${config.sessionId})`, 'bi-link-45deg');
            updateStatus('İşlem devam ediyor...', 'info');
        });

        // İlerleme Güncellemeleri
        socket.on('progress', (data) => {
            updateProgress('progressBar', 'progressPercent', data.progress);
            updateTimeEstimation(data.progress);
            config.lastProgress = data.progress;
        });

        socket.on('segment_progress', (data) => {
            updateProgress('segmentProgressBar', null, data.segment_progress);
        });

        // Segment Bilgisi
        socket.on('segment_started', (data) => {
            document.getElementById('segmentName').textContent = data.filename;
            addLog(`Yeni segment: ${data.filename}`, 'bi-play-fill');
        });

        // İşlem Tamamlandığında
        socket.on('processing_complete', (data) => {
            if (data.success) {
                handleCompletion(data.processed_filename);
            } else {
                showError(data.message);
            }
        });

        // Hata Durumu
        socket.on('error', (data) => {
            showError(data.message);
        });
    }

    // İşlem Tamamlandığında
    function handleCompletion(filename) {
        config.pollingActive = false;

        // UI Güncellemeleri
        updateProgress('progressBar', 'progressPercent', 100);
        updateProgress('segmentProgressBar', null, 100);
        updateStatus('İşlem tamamlandı!', 'success');

        // Butonu Göster
        document.getElementById('successSection').style.display = 'block';
        document.getElementById('completionMessage').textContent =
            `İşlem tamamlandı! (Dosya: ${filename.split('_').pop()})`;

        // Buton Eventi
        document.getElementById('showResultBtn').addEventListener('click', () => {
            window.location.href = `/upload_success?video=${encodeURIComponent(filename)}`;
        });

        addLog(`İşlem başarıyla tamamlandı`, 'bi-check2-all', 'success');
    }

    // Yardımcı Fonksiyonlar
    function updateProgress(barId, percentId, value) {
        const bar = document.getElementById(barId);
        const percent = Math.min(100, Math.max(0, value));

        // Görsel Güncelleme
        bar.style.width = `${percent}%`;
        bar.classList.remove('bg-danger', 'bg-warning', 'bg-success', 'bg-info');

        if (percent < 30) bar.classList.add('bg-danger');
        else if (percent < 70) bar.classList.add('bg-warning');
        else bar.classList.add('bg-success');

        if (percentId) {
            document.getElementById(percentId).textContent = `%${percent.toFixed(1)}`;
        }
    }

    function updateTimeEstimation(progress) {
        if (!config.startTime || progress <= 0) return;

        const elapsed = (new Date() - config.startTime) / 1000;
        const remaining = progress > 0 ? (elapsed / progress) * (100 - progress) : 0;

        document.getElementById('timeRemaining').innerHTML = `
            <i class="bi bi-clock-history"></i> Tahmini: ${Math.round(remaining)}s`;
    }

    function updateStatus(text, type = 'info') {
        const badge = document.getElementById('statusBadge');
        badge.className = `badge fs-6 bg-${type === 'info' ? 'primary' : type === 'success' ? 'success' : 'danger'}`;
        document.getElementById('statusText').textContent = text;

        if (type === 'success') {
            document.getElementById('statusSpinner').style.display = 'none';
        }
    }

    function addLog(message, icon, type = 'info') {
        const logEntry = document.createElement('div');
        logEntry.className = `list-group-item list-group-item-action ${type === 'success' ? 'list-group-item-success' : type === 'error' ? 'list-group-item-danger' : 'bg-dark text-white'}`;
        logEntry.innerHTML = `
            <i class="bi ${icon} me-2"></i>
            ${message}
            <small class="float-end text-muted">${moment().format('HH:mm:ss')}</small>
        `;

        const logsContainer = document.getElementById('processLogs');
        logsContainer.appendChild(logEntry);
        logsContainer.scrollTop = logsContainer.scrollHeight;
    }

    function showError(message) {
        config.pollingActive = false;
        updateStatus('Hata oluştu!', 'error');

        document.getElementById('errorText').textContent = message;
        document.getElementById('errorAlert').style.display = 'block';

        addLog(`HATA: ${message}`, 'bi-exclamation-triangle-fill', 'error');
    }
</script>

<!-- Stiller -->
<style>
    .progress-bar {
        transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    }
    #successSection {
        opacity: 0;
        transition: opacity 0.5s ease;
    }
    #successSection.show {
        opacity: 1;
    }
    #showResultBtn {
        transition: all 0.3s;
    }
    #showResultBtn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(25, 135, 84, 0.3);
    }
    #processLogs::-webkit-scrollbar {
        width: 8px;
    }
    #processLogs::-webkit-scrollbar-thumb {
        background-color: #495057;
        border-radius: 4px;
    }
</style>
{% endblock %}