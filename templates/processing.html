{% extends 'base.html' %}

{% block title %}Video İşleme Durumu{% endblock %}

{% block content %}
<div class="container mt-5">
    <!-- Ana Başlık -->
    <h2 class="text-white mb-4">
        <i class="bi bi-gear-wide-connected"></i> Video İşleme Durumu
    </h2>

    <!-- Ana İlerleme Çubuğu -->
    <div class="card bg-dark text-white mb-4">
        <div class="card-header">
            <h5 class="mb-0">
                <i class="bi bi-speedometer2"></i> Toplam İlerleme
                <span id="progressPercent" class="float-end">%0</span>
            </h5>
        </div>
        <div class="card-body">
            <div class="progress" style="height: 25px;">
                <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated"
                     role="progressbar" style="width: 0%">
                </div>
            </div>
            <small class="text-muted mt-2 d-block">
                <i class="bi bi-clock"></i> <span id="timeRemaining">Tahmini kalan süre: hesaplanıyor...</span>
            </small>
        </div>
    </div>

    <!-- Segment İlerleme -->
    <div class="card bg-dark text-white mb-4">
        <div class="card-header">
            <h5 class="mb-0">
                <i class="bi bi-film"></i> Aktif Segment
                <span id="segmentProgressPercent" class="float-end">%0</span>
            </h5>
        </div>
        <div class="card-body">
            <div class="progress" style="height: 20px;">
                <div id="segmentProgressBar" class="progress-bar"
                     role="progressbar" style="width: 0%">
                </div>
            </div>
            <small id="segmentName" class="text-muted mt-2 d-block">Segment hazırlanıyor...</small>
        </div>
    </div>


    <!-- İşlem Tamamlandı Butonu (Başta Gizli) -->
    <div id="successSection" class="text-center mt-4" style="display: none;">
        <div class="alert alert-success">
            <i class="bi bi-check-circle-fill"></i> Video işleme tamamlandı!
        </div>
        <a id="showResultBtn" href="#" class="btn btn-success btn-lg">
            <i class="bi bi-play-fill"></i> Sonucu Görüntüle
        </a>
    </div>

    <!-- Hata Mesajı -->
    <div id="errorAlert" class="alert alert-danger mt-4" style="display: none;">
        <i class="bi bi-exclamation-triangle-fill"></i>
        <span id="errorText"></span>
    </div>

    <!-- İşlem Geçmişi -->
    <div class="card bg-dark text-white mt-4">
        <div class="card-header">
            <h5 class="mb-0"><i class="bi bi-list-ul"></i> İşlem Geçmişi</h5>
        </div>
        <div class="card-body p-0">
            <ul id="processLogs" class="list-group list-group-flush" style="max-height: 200px; overflow-y: auto;">
                <li class="list-group-item bg-secondary text-white">
                    <i class="bi bi-hourglass-top"></i> Sistem başlatıldı...
                </li>
            </ul>
        </div>
    </div>
</div>

<!-- Socket.io Bağlantısı -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.6.1/socket.io.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">

<script>
    // Socket Bağlantısı
    const socket = io('http://' + window.location.hostname + ':5000');
    let startTime = null;

    // İlerleme Çubuklarını Güncelle
    function updateProgress(barId, percentId, value) {
        const bar = document.getElementById(barId);
        const percentElement = document.getElementById(percentId);
        const percent = Math.min(100, Math.max(0, value));

        // Çubuk Güncelleme
        bar.style.width = `${percent}%`;
        percentElement.textContent = `%${percent.toFixed(1)}`;

        // Renk Değişimi (kırmızı -> sarı -> yeşil)
        bar.className = bar.className.replace(/bg-\w+/g, '');
        if (percent < 30) {
            bar.classList.add('bg-danger');
        } else if (percent < 70) {
            bar.classList.add('bg-warning');
        } else {
            bar.classList.add('bg-success');
        }

        // Tahmini süre hesaplama
        if (barId === 'progressBar' && percent > 0) {
            updateTimeEstimation(percent);
        }
    }

    // Tahmini Kalan Süre
    function updateTimeEstimation(progress) {
        if (!startTime) startTime = new Date();

        const elapsed = (new Date() - startTime) / 1000; // saniye
        const remaining = (elapsed / progress) * (100 - progress);

        document.getElementById('timeRemaining').textContent =
            `Tahmini kalan süre: ${Math.round(remaining)} saniye`;
    }

    // Geçmişe Kayıt Ekle
    function addLog(message, icon = 'bi-info-circle', type = 'info') {
        const logEntry = document.createElement('li');
        logEntry.className = `list-group-item ${type === 'error' ? 'list-group-item-danger' : 'bg-dark text-white'}`;
        logEntry.innerHTML = `
            <i class="bi ${icon}"></i> ${message}
            <small class="float-end text-muted">${moment().format('HH:mm:ss')}</small>
        `;
        document.getElementById('processLogs').appendChild(logEntry);
    }

    // Socket Olayları
    socket.on('progress', (data) => {
        updateProgress('progressBar', 'progressPercent', data.progress);
    });

    socket.on('segment_progress', (data) => {
        updateProgress('segmentProgressBar', 'segmentProgressPercent', data.segment_progress);
    });

    socket.on('segment_started', (data) => {
        document.getElementById('segmentName').textContent = data.filename;
        addLog(`Yeni segment başladı: ${data.filename}`, 'bi-play-fill');
    });

    socket.on('processing_complete', (data) => {
        if (data.success) {
            updateProgress('progressBar', 'progressPercent', 100);
            updateProgress('segmentProgressBar', 'segmentProgressPercent', 100);
            document.getElementById('successSection').style.display = 'block';
            addLog('İşlem başarıyla tamamlandı!', 'bi-check2-circle', 'success');

            document.getElementById('showResultBtn').onclick = () => {
                window.location.href = `/upload_success?video=${encodeURIComponent(data.processed_filename)}`;
            };
        } else {
            document.getElementById('errorText').textContent = data.message;
            document.getElementById('errorAlert').style.display = 'block';
            addLog(`Hata: ${data.message}`, 'bi-exclamation-triangle', 'error');
        }
    });

    // Sayfa yüklendiğinde başlangıç zamanını ayarla
    document.addEventListener('DOMContentLoaded', () => {
        startTime = new Date();
        addLog('WebSocket bağlantısı kuruldu', 'bi-plug');
    });
</script>

<style>
    .progress-bar {
        transition: width 0.5s ease;
    }
    #successSection {
        animation: fadeIn 0.5s ease-out;
    }
    #processLogs {
        scrollbar-width: thin;
        scrollbar-color: #495057 #212529;
    }
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }
</style>
{% endblock %}